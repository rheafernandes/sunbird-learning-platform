package org.ekstep.itemset.handler;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.ekstep.common.mgr.ConvertToGraphNode;
import org.ekstep.graph.dac.model.Node;
import org.ekstep.graph.dac.model.Relation;
import org.ekstep.graph.engine.common.GraphEngineTestSetup;
import org.ekstep.graph.model.node.DefinitionDTO;
import org.ekstep.learning.util.ControllerUtil;
import org.junit.AfterClass;
import org.junit.Assert;
import org.junit.BeforeClass;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mockito;
import org.powermock.api.mockito.PowerMockito;
import org.powermock.core.classloader.annotations.PowerMockIgnore;
import org.powermock.core.classloader.annotations.PrepareForTest;
import org.powermock.modules.junit4.PowerMockRunner;


import java.io.File;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

@RunWith(PowerMockRunner.class)
@PrepareForTest({QuestionPaperGeneratorUtil.class})
@PowerMockIgnore({"javax.management.*", "sun.security.ssl.*", "javax.net.ssl.*" , "javax.crypto.*"})
public class QuestionPaperGeneratorTest extends GraphEngineTestSetup{

    ObjectMapper mapper = new ObjectMapper();
    
    
    @BeforeClass
    public static void create() throws Exception {
    		loadDefinition("definitions/content_definition.json", "definitions/item_definition.json",
    				"definitions/itemset_definition.json");
    	}

    @AfterClass
    public static void destroy() {

    }

    @Test
    public void testGetFileName() {
        String fileName = QuestionPaperGenerator.getFileName("html_");
        Assert.assertNotNull(fileName);
    }

    @Test
    public void testGenerateQuestionPaper() throws Exception{
    		
    		String itemSet = "{\"id\":986983,\"graphId\":\"domain\",\"identifier\":\"do_11292667205373132811\",\"nodeType\":\"DATA_NODE\",\"objectType\":\"ItemSet\",\"metadata\":{\"owner\":\"Ilimi\",\"lastStatusChangedOn\":\"2020-01-02T16:31:37.174+0530\",\"code\":\"akshara.grade5.ws1.test\",\"previewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/itemset/do_11292667205373132811/do_11292667205373132811_html_1578314155877.html\",\"channel\":\"in.ekstep\",\"SET_OBJECT_TYPE_KEY\":\"AssessmentItem\",\"description\":\"Akshara Worksheet Grade 5 Item Set\",\"language\":[\"English\"],\"title\":\"Akshara Worksheet Grade 5 Item Set\",\"type\":\"materialised\",\"total_items\":1,\"createdOn\":\"2020-01-02T16:31:37.174+0530\",\"versionKey\":\"1578314159042\",\"gradeLevel\":[\"Grade 1\"],\"max_score\":1,\"lastUpdatedOn\":\"2020-01-06T18:05:59.042+0530\",\"used_for\":\"assessment\",\"items\":\"[{\\\"identifier\\\":\\\"test.mcq_test_mcq_101\\\"}]\",\"SET_TYPE\":\"MATERIALISED_SET\",\"status\":\"Live\"},\"outRelations\":[{\"id\":824419,\"graphId\":\"domain\",\"relationType\":\"hasSequenceMember\",\"startNodeId\":\"do_11292667205373132811\",\"endNodeId\":\"test.mcq_test_mcq_101\",\"startNodeName\":\"Akshara Worksheet Grade 5 Item Set\",\"endNodeName\":\"Mmcq Question 2\",\"startNodeType\":\"DATA_NODE\",\"endNodeType\":\"DATA_NODE\",\"startNodeObjectType\":\"ItemSet\",\"endNodeObjectType\":\"AssessmentItem\",\"metadata\":{\"IL_SEQUENCE_INDEX\":1},\"startNodeMetadata\":{\"owner\":\"Ilimi\",\"lastStatusChangedOn\":\"2020-01-02T16:31:37.174+0530\",\"code\":\"akshara.grade5.ws1.test\",\"previewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/itemset/do_11292667205373132811/do_11292667205373132811_html_1578314155877.html\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"channel\":\"in.ekstep\",\"SET_OBJECT_TYPE_KEY\":\"AssessmentItem\",\"description\":\"Akshara Worksheet Grade 5 Item Set\",\"language\":[\"English\"],\"title\":\"Akshara Worksheet Grade 5 Item Set\",\"type\":\"materialised\",\"total_items\":1,\"createdOn\":\"2020-01-02T16:31:37.174+0530\",\"versionKey\":\"1578314159042\",\"gradeLevel\":[\"Grade 1\"],\"max_score\":1,\"IL_FUNC_OBJECT_TYPE\":\"ItemSet\",\"lastUpdatedOn\":\"2020-01-06T18:05:59.042+0530\",\"used_for\":\"assessment\",\"items\":\"[{\\\"identifier\\\":\\\"test.mcq_test_mcq_101\\\"}]\",\"IL_UNIQUE_ID\":\"do_11292667205373132811\",\"SET_TYPE\":\"MATERIALISED_SET\",\"status\":\"Live\"},\"endNodeMetadata\":{\"itemType\":\"UNIT\",\"code\":\"test.mcq_misxed_115\",\"qlevel\":\"MEDIUM\",\"channel\":\"in.ekstep\",\"responseDeclaration\":\"{\\\"responseValue\\\":{\\\"cardinality\\\":\\\"single\\\",\\\"type\\\":\\\"integer\\\",\\\"correct_response\\\":{\\\"value\\\":\\\"1\\\"}}}\",\"language\":[\"English\"],\"partial_scoring\":false,\"title\":\"ಈ ಚaಿತ್ರದ ವಿಸ್xsxxxxxxxxxxxxತೀರ್ಣವನ್ನುzsaZZ ಹಾಗೂ ಸುತ್ತಳತೆಯನ್ನು ಲೆಕ್ಕ ಮಾಡಿ.  ಸೂಕ್ತ ಉತ್ತರವನ್ನು ಆರಿಸಿರಿ.\",\"type\":\"mcq\",\"createdOn\":\"2020-01-02T16:28:15.005+0530\",\"feedback\":\"\",\"options\":\"[{\\\"value\\\":{\\\"type\\\":\\\"text\\\",\\\"asset\\\":\\\"12&10\\\",\\\"resvalue\\\":0,\\\"resindex\\\":0}},{\\\"value\\\":{\\\"type\\\":\\\"text\\\",\\\"asset\\\":\\\"14&7\\\",\\\"resvalue\\\":1,\\\"resindex\\\":1}},{\\\"value\\\":{\\\"type\\\":\\\"mixed\\\",\\\"text\\\":\\\"16&8\\\",\\\"image\\\":\\\"image1\\\",\\\"audio\\\":\\\"audio1\\\",\\\"resvalue\\\":\\\"16&8\\\",\\\"resindex\\\":2}},{\\\"value\\\":{\\\"type\\\":\\\"mixed\\\",\\\"image\\\":\\\"image2\\\",\\\"audio\\\":\\\"audio2\\\",\\\"resvalue\\\":3,\\\"resindex\\\":3},\\\"answer\\\":true}]\",\"outRelations\":\"[{\\\"endNodeId\\\":\\\"Num:C1:SC1\\\",\\\"relationType\\\":\\\"associatedTo\\\"},{\\\"endNodeId\\\":\\\"Num:C1:SC1\\\",\\\"relationType\\\":\\\"associatedTo\\\"}]\",\"lastUpdatedOn\":\"2020-01-02T16:28:15.005+0530\",\"model\":\"{\\\"img\\\":{\\\"type\\\":\\\"image\\\",\\\"asset\\\":\\\"persximeter\\\"},\\\"img2\\\":{\\\"type\\\":\\\"image\\\",\\\"asset\\\":\\\"smallssssssSquare\\\"},\\\"subtext\\\":\\\"(          = 1  ಚದರ ಸೆಂ.ಮೀ)\\\"}\",\"owner\":\"username_2\",\"lastStatusChangedOn\":\"2020-01-02T16:28:15.005+0530\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"version\":1,\"tags\":[\"english\",\"hindi\"],\"versionKey\":\"1577962695005\",\"framework\":\"NCF\",\"max_score\":1,\"IL_FUNC_OBJECT_TYPE\":\"AssessmentItem\",\"name\":\"Mmcq Question 2\",\"responses\":\"[{\\\"values\\\":{\\\"12&10\\\":true},\\\"score\\\":1}]\",\"num_answers\":2,\"template_id\":\"mcq_mmtemplate_2\",\"category\":\"MCQ\",\"IL_UNIQUE_ID\":\"test.mcq_test_mcq_101\",\"status\":\"Live\"}}],\"inRelations\":[{\"id\":824398,\"graphId\":\"domain\",\"relationType\":\"hasSequenceMember\",\"startNodeId\":\"do_11292666508456755211\",\"endNodeId\":\"do_11292667205373132811\",\"startNodeName\":\"Test_PDF\",\"endNodeName\":\"Akshara Worksheet Grade 5 Item Set\",\"startNodeType\":\"DATA_NODE\",\"endNodeType\":\"DATA_NODE\",\"startNodeObjectType\":\"Content\",\"endNodeObjectType\":\"ItemSet\",\"metadata\":{\"IL_SEQUENCE_INDEX\":1},\"startNodeMetadata\":{\"ownershipType\":[\"createdBy\"],\"publish_type\":\"public\",\"previewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/content/do_11292666508456755211/artifact/1_1577963911728.pdf\",\"code\":\"Test_PDF\",\"publishError\":\"Error During Itemset Publish. Please Try Again After Sometime!\",\"downloadUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/ecar_files/do_11292666508456755211/test_pdf_1578314256565_do_11292666508456755211_21.0.ecar\",\"channel\":\"channel-1\",\"language\":[\"English\"],\"variants\":\"{\\\"spine\\\":{\\\"ecarUrl\\\":\\\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/ecar_files/do_11292666508456755211/test_pdf_1578314257331_do_11292666508456755211_21.0_spine.ecar\\\",\\\"size\\\":2088.0}}\",\"mimeType\":\"application/pdf\",\"streamingUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/content/do_11292666508456755211/artifact/1_1577963911728.pdf\",\"idealScreenSize\":\"normal\",\"createdOn\":\"2020-01-02T16:17:28.138+0530\",\"contentDisposition\":\"inline\",\"artifactUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/content/do_11292666508456755211/artifact/1_1577963911728.pdf\",\"contentEncoding\":\"identity\",\"lastUpdatedOn\":\"2020-01-07T12:34:39.496+0530\",\"SYS_INTERNAL_LAST_UPDATED_ON\":\"2020-01-06T18:07:38.351+0530\",\"contentType\":\"Resource\",\"dialcodeRequired\":\"No\",\"lastUpdatedBy\":\"Ekstep\",\"audience\":[\"Learner\"],\"lastStatusChangedOn\":\"2020-01-06T18:44:48.759+0530\",\"os\":[\"All\"],\"visibility\":\"Default\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"mediaType\":\"content\",\"osId\":\"org.ekstep.quiz.app\",\"lastPublishedBy\":\"Ekstep\",\"version\":2,\"pkgVersion\":21.0,\"pragma\":[\"external\"],\"versionKey\":\"1578380679496\",\"idealScreenDensity\":\"hdpi\",\"license\":\"Creative Commons Attribution (CC BY)\",\"framework\":\"NCF\",\"s3Key\":\"ecar_files/do_11292666508456755211/test_pdf_1578314256565_do_11292666508456755211_21.0.ecar\",\"lastPublishedOn\":\"2020-01-06T18:07:36.315+0530\",\"size\":413860.0,\"compatibilityLevel\":4,\"IL_FUNC_OBJECT_TYPE\":\"Content\",\"name\":\"Test_PDF\",\"publisher\":\"EkStep\",\"itemSetPreviewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/content/do_11292666508456755211/artifact/do_11292666508456755211_1578314178385.html\",\"IL_UNIQUE_ID\":\"do_11292666508456755211\",\"status\":\"Failed\"},\"endNodeMetadata\":{\"owner\":\"Ilimi\",\"lastStatusChangedOn\":\"2020-01-02T16:31:37.174+0530\",\"code\":\"akshara.grade5.ws1.test\",\"previewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/itemset/do_11292667205373132811/do_11292667205373132811_html_1578314155877.html\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"channel\":\"in.ekstep\",\"SET_OBJECT_TYPE_KEY\":\"AssessmentItem\",\"description\":\"Akshara Worksheet Grade 5 Item Set\",\"language\":[\"English\"],\"title\":\"Akshara Worksheet Grade 5 Item Set\",\"type\":\"materialised\",\"total_items\":1,\"createdOn\":\"2020-01-02T16:31:37.174+0530\",\"versionKey\":\"1578314159042\",\"gradeLevel\":[\"Grade 1\"],\"max_score\":1,\"IL_FUNC_OBJECT_TYPE\":\"ItemSet\",\"lastUpdatedOn\":\"2020-01-06T18:05:59.042+0530\",\"used_for\":\"assessment\",\"items\":\"[{\\\"identifier\\\":\\\"test.mcq_test_mcq_101\\\"}]\",\"IL_UNIQUE_ID\":\"do_11292667205373132811\",\"SET_TYPE\":\"MATERIALISED_SET\",\"status\":\"Live\"}}],\"tags\":null}";
    		Map<String, Object> nodeMap = mapper.readValue(itemSet, Map.class);
    		DefinitionDTO d = new ControllerUtil().getDefinition("domain", "ItemSet");
    		Node node = ConvertToGraphNode.convertToGraphNode(nodeMap, d, null);
    		Relation r = new Relation("do_11292667205373132811", "hasSequenceMember", "test.mcq_test_mcq_101");
    		Map<String, Object> relationMataData = new HashMap<>();
    		relationMataData.put("IL_SEQUENCE_INDEX", 1);
    		r.setMetadata(relationMataData);
    		r.setStartNodeObjectType("ItemSet");
    		r.setEndNodeObjectType("AssessmentItem");
    		node.setOutRelations(Arrays.asList(r));
    		System.out.println(node.getOutRelations().size());
    		
    		
    		PowerMockito.mockStatic(QuestionPaperGeneratorUtil.class);		
    		try {
    			String questionNodeMapString = "{\"outRelations\":\"[{\\\"endNodeId\\\":\\\"Num:C1:SC1\\\",\\\"relationType\\\":\\\"associatedTo\\\"},{\\\"endNodeId\\\":\\\"Num:C1:SC1\\\",\\\"relationType\\\":\\\"associatedTo\\\"}]\",\"inRelations\":[{\"id\":824419,\"graphId\":\"domain\",\"relationType\":\"hasSequenceMember\",\"startNodeId\":\"do_11292667205373132811\",\"endNodeId\":\"test.mcq_test_mcq_101\",\"startNodeName\":\"Akshara Worksheet Grade 5 Item Set\",\"endNodeName\":\"Mmcq Question 2\",\"startNodeType\":\"DATA_NODE\",\"endNodeType\":\"DATA_NODE\",\"startNodeObjectType\":\"ItemSet\",\"endNodeObjectType\":\"AssessmentItem\",\"metadata\":{\"IL_SEQUENCE_INDEX\":1},\"startNodeMetadata\":{\"owner\":\"Ilimi\",\"lastStatusChangedOn\":\"2020-01-02T16:31:37.174+0530\",\"code\":\"akshara.grade5.ws1.test\",\"previewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/itemset/do_11292667205373132811/do_11292667205373132811_html_1578314155877.html\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"channel\":\"in.ekstep\",\"SET_OBJECT_TYPE_KEY\":\"AssessmentItem\",\"description\":\"Akshara Worksheet Grade 5 Item Set\",\"language\":[\"English\"],\"title\":\"Akshara Worksheet Grade 5 Item Set\",\"type\":\"materialised\",\"total_items\":1,\"createdOn\":\"2020-01-02T16:31:37.174+0530\",\"versionKey\":\"1578314159042\",\"gradeLevel\":[\"Grade 1\"],\"max_score\":1,\"IL_FUNC_OBJECT_TYPE\":\"ItemSet\",\"lastUpdatedOn\":\"2020-01-06T18:05:59.042+0530\",\"used_for\":\"assessment\",\"items\":\"[{\\\"identifier\\\":\\\"test.mcq_test_mcq_101\\\"}]\",\"IL_UNIQUE_ID\":\"do_11292667205373132811\",\"SET_TYPE\":\"MATERIALISED_SET\",\"status\":\"Live\"},\"endNodeMetadata\":{\"itemType\":\"UNIT\",\"code\":\"test.mcq_misxed_115\",\"qlevel\":\"MEDIUM\",\"channel\":\"in.ekstep\",\"responseDeclaration\":\"{\\\"responseValue\\\":{\\\"cardinality\\\":\\\"single\\\",\\\"type\\\":\\\"integer\\\",\\\"correct_response\\\":{\\\"value\\\":\\\"1\\\"}}}\",\"language\":[\"English\"],\"partial_scoring\":false,\"title\":\"ಈ ಚaಿತ್ರದ ವಿಸ್xsxxxxxxxxxxxxತೀರ್ಣವನ್ನುzsaZZ ಹಾಗೂ ಸುತ್ತಳತೆಯನ್ನು ಲೆಕ್ಕ ಮಾಡಿ.  ಸೂಕ್ತ ಉತ್ತರವನ್ನು ಆರಿಸಿರಿ.\",\"type\":\"mcq\",\"createdOn\":\"2020-01-02T16:28:15.005+0530\",\"feedback\":\"\",\"options\":\"[{\\\"value\\\":{\\\"type\\\":\\\"text\\\",\\\"asset\\\":\\\"12&10\\\",\\\"resvalue\\\":0,\\\"resindex\\\":0}},{\\\"value\\\":{\\\"type\\\":\\\"text\\\",\\\"asset\\\":\\\"14&7\\\",\\\"resvalue\\\":1,\\\"resindex\\\":1}},{\\\"value\\\":{\\\"type\\\":\\\"mixed\\\",\\\"text\\\":\\\"16&8\\\",\\\"image\\\":\\\"image1\\\",\\\"audio\\\":\\\"audio1\\\",\\\"resvalue\\\":\\\"16&8\\\",\\\"resindex\\\":2}},{\\\"value\\\":{\\\"type\\\":\\\"mixed\\\",\\\"image\\\":\\\"image2\\\",\\\"audio\\\":\\\"audio2\\\",\\\"resvalue\\\":3,\\\"resindex\\\":3},\\\"answer\\\":true}]\",\"outRelations\":\"[{\\\"endNodeId\\\":\\\"Num:C1:SC1\\\",\\\"relationType\\\":\\\"associatedTo\\\"},{\\\"endNodeId\\\":\\\"Num:C1:SC1\\\",\\\"relationType\\\":\\\"associatedTo\\\"}]\",\"lastUpdatedOn\":\"2020-01-02T16:28:15.005+0530\",\"model\":\"{\\\"img\\\":{\\\"type\\\":\\\"image\\\",\\\"asset\\\":\\\"persximeter\\\"},\\\"img2\\\":{\\\"type\\\":\\\"image\\\",\\\"asset\\\":\\\"smallssssssSquare\\\"},\\\"subtext\\\":\\\"(          = 1  ಚದರ ಸೆಂ.ಮೀ)\\\"}\",\"owner\":\"username_2\",\"lastStatusChangedOn\":\"2020-01-02T16:28:15.005+0530\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"version\":1,\"tags\":[\"english\",\"hindi\"],\"versionKey\":\"1577962695005\",\"framework\":\"NCF\",\"max_score\":1,\"IL_FUNC_OBJECT_TYPE\":\"AssessmentItem\",\"name\":\"Mmcq Question 2\",\"responses\":\"[{\\\"values\\\":{\\\"12&10\\\":true},\\\"score\\\":1}]\",\"num_answers\":2,\"template_id\":\"mcq_mmtemplate_2\",\"category\":\"MCQ\",\"IL_UNIQUE_ID\":\"test.mcq_test_mcq_101\",\"status\":\"Live\"}}],\"identifier\":\"test.mcq_test_mcq_101\",\"objectType\":\"AssessmentItem\",\"itemType\":\"UNIT\",\"code\":\"test.mcq_misxed_115\",\"qlevel\":\"MEDIUM\",\"channel\":\"in.ekstep\",\"responseDeclaration\":\"{\\\"responseValue\\\":{\\\"cardinality\\\":\\\"single\\\",\\\"type\\\":\\\"integer\\\",\\\"correct_response\\\":{\\\"value\\\":\\\"1\\\"}}}\",\"language\":[\"English\"],\"partial_scoring\":false,\"title\":\"ಈ ಚaಿತ್ರದ ವಿಸ್xsxxxxxxxxxxxxತೀರ್ಣವನ್ನುzsaZZ ಹಾಗೂ ಸುತ್ತಳತೆಯನ್ನು ಲೆಕ್ಕ ಮಾಡಿ.  ಸೂಕ್ತ ಉತ್ತರವನ್ನು ಆರಿಸಿರಿ.\",\"type\":\"mcq\",\"createdOn\":\"2020-01-02T16:28:15.005+0530\",\"feedback\":\"\",\"options\":\"[{\\\"value\\\":{\\\"type\\\":\\\"text\\\",\\\"asset\\\":\\\"12&10\\\",\\\"resvalue\\\":0,\\\"resindex\\\":0}},{\\\"value\\\":{\\\"type\\\":\\\"text\\\",\\\"asset\\\":\\\"14&7\\\",\\\"resvalue\\\":1,\\\"resindex\\\":1}},{\\\"value\\\":{\\\"type\\\":\\\"mixed\\\",\\\"text\\\":\\\"16&8\\\",\\\"image\\\":\\\"image1\\\",\\\"audio\\\":\\\"audio1\\\",\\\"resvalue\\\":\\\"16&8\\\",\\\"resindex\\\":2}},{\\\"value\\\":{\\\"type\\\":\\\"mixed\\\",\\\"image\\\":\\\"image2\\\",\\\"audio\\\":\\\"audio2\\\",\\\"resvalue\\\":3,\\\"resindex\\\":3},\\\"answer\\\":true}]\",\"lastUpdatedOn\":\"2020-01-02T16:28:15.005+0530\",\"model\":\"{\\\"img\\\":{\\\"type\\\":\\\"image\\\",\\\"asset\\\":\\\"persximeter\\\"},\\\"img2\\\":{\\\"type\\\":\\\"image\\\",\\\"asset\\\":\\\"smallssssssSquare\\\"},\\\"subtext\\\":\\\"(          = 1  ಚದರ ಸೆಂ.ಮೀ)\\\"}\",\"owner\":\"username_2\",\"lastStatusChangedOn\":\"2020-01-02T16:28:15.005+0530\",\"version\":1,\"tags\":[\"english\",\"hindi\"],\"versionKey\":\"1577962695005\",\"framework\":\"NCF\",\"max_score\":1,\"name\":\"Mmcq Question 2\",\"responses\":\"[{\\\"values\\\":{\\\"12&10\\\":true},\\\"score\\\":1}]\",\"num_answers\":2,\"template_id\":\"mcq_mmtemplate_2\",\"category\":\"MCQ\",\"status\":\"Live\"}";
        		Map<String, Object> questionNodeMap = mapper.readValue(questionNodeMapString, HashMap.class);
        		d = new ControllerUtil().getDefinition("domain", "AssessmentItem");
        		Node assessmentItemNode = ConvertToGraphNode.convertToGraphNode(questionNodeMap, d, null);
        		Map<String, Object> questionMap = new HashMap<>();
        		questionMap.put("test.mcq_test_mcq_101", assessmentItemNode);
        		PowerMockito.when(QuestionPaperGeneratorUtil.getMetadataFromNeo4j(Mockito.anyList())).thenReturn(questionMap);
        		
        		String questionNodeBodyString = "{\"test.mcq_test_mcq_101\":{\"body\":\"<div class='mcq-vertical cheveron-helper'><div class='mcq-title'><p>Which of the following sets of tests would be LEAST urgently indicated for a patient presenting with intraocular pressures of R 22mmHg and L 46mmHg?</p></div><i class='chevron down icon'></i><div class='mcq-options'><div data-simple-choice-interaction data-response-variable='responseValue' value=0 class='mcq-option'><p>Visual field examination and dilated optic nerve head assessment</p></div><div data-simple-choice-interaction data-response-variable='responseValue' value=1 class='mcq-option'><p>Examination of the irides and anterior chamber assessment for cells and flare</p></div><div data-simple-choice-interaction data-response-variable='responseValue' value=2 class='mcq-option'><p>Gonioscopy and assessment of the lens capsule</p></div><div data-simple-choice-interaction data-response-variable='responseValue' value=3 class='mcq-option'><p>Assessment of the corneal endothelium and iris transillumination</p></div></div></div>\"}}";
        		Map<String, Object> questionBodyMap = mapper.readValue(questionNodeBodyString, HashMap.class);
        		PowerMockito.when(QuestionPaperGeneratorUtil.getExternalPropsData(Mockito.anyList())).thenReturn(questionBodyMap);
        		
        		File file = QuestionPaperGenerator.generateQuestionPaper(node);
        		System.out.println(file.getAbsolutePath());
    		}catch(Exception e) {
    			e.printStackTrace();
    		}
    }

    @Test
    public void testFetchChildDetails() throws Exception {
    	String itemSet = "{\"id\":986983,\"graphId\":\"domain\",\"identifier\":\"do_11292667205373132811\",\"nodeType\":\"DATA_NODE\",\"objectType\":\"ItemSet\",\"metadata\":{\"owner\":\"Ilimi\",\"lastStatusChangedOn\":\"2020-01-02T16:31:37.174+0530\",\"code\":\"akshara.grade5.ws1.test\",\"previewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/itemset/do_11292667205373132811/do_11292667205373132811_html_1578314155877.html\",\"channel\":\"in.ekstep\",\"SET_OBJECT_TYPE_KEY\":\"AssessmentItem\",\"description\":\"Akshara Worksheet Grade 5 Item Set\",\"language\":[\"English\"],\"title\":\"Akshara Worksheet Grade 5 Item Set\",\"type\":\"materialised\",\"total_items\":1,\"createdOn\":\"2020-01-02T16:31:37.174+0530\",\"versionKey\":\"1578314159042\",\"gradeLevel\":[\"Grade 1\"],\"max_score\":1,\"lastUpdatedOn\":\"2020-01-06T18:05:59.042+0530\",\"used_for\":\"assessment\",\"items\":\"[{\\\"identifier\\\":\\\"test.mcq_test_mcq_101\\\"}]\",\"SET_TYPE\":\"MATERIALISED_SET\",\"status\":\"Live\"},\"outRelations\":[{\"id\":824419,\"graphId\":\"domain\",\"relationType\":\"hasSequenceMember\",\"startNodeId\":\"do_11292667205373132811\",\"endNodeId\":\"test.mcq_test_mcq_101\",\"startNodeName\":\"Akshara Worksheet Grade 5 Item Set\",\"endNodeName\":\"Mmcq Question 2\",\"startNodeType\":\"DATA_NODE\",\"endNodeType\":\"DATA_NODE\",\"startNodeObjectType\":\"ItemSet\",\"endNodeObjectType\":\"AssessmentItem\",\"metadata\":{\"IL_SEQUENCE_INDEX\":1},\"startNodeMetadata\":{\"owner\":\"Ilimi\",\"lastStatusChangedOn\":\"2020-01-02T16:31:37.174+0530\",\"code\":\"akshara.grade5.ws1.test\",\"previewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/itemset/do_11292667205373132811/do_11292667205373132811_html_1578314155877.html\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"channel\":\"in.ekstep\",\"SET_OBJECT_TYPE_KEY\":\"AssessmentItem\",\"description\":\"Akshara Worksheet Grade 5 Item Set\",\"language\":[\"English\"],\"title\":\"Akshara Worksheet Grade 5 Item Set\",\"type\":\"materialised\",\"total_items\":1,\"createdOn\":\"2020-01-02T16:31:37.174+0530\",\"versionKey\":\"1578314159042\",\"gradeLevel\":[\"Grade 1\"],\"max_score\":1,\"IL_FUNC_OBJECT_TYPE\":\"ItemSet\",\"lastUpdatedOn\":\"2020-01-06T18:05:59.042+0530\",\"used_for\":\"assessment\",\"items\":\"[{\\\"identifier\\\":\\\"test.mcq_test_mcq_101\\\"}]\",\"IL_UNIQUE_ID\":\"do_11292667205373132811\",\"SET_TYPE\":\"MATERIALISED_SET\",\"status\":\"Live\"},\"endNodeMetadata\":{\"itemType\":\"UNIT\",\"code\":\"test.mcq_misxed_115\",\"qlevel\":\"MEDIUM\",\"channel\":\"in.ekstep\",\"responseDeclaration\":\"{\\\"responseValue\\\":{\\\"cardinality\\\":\\\"single\\\",\\\"type\\\":\\\"integer\\\",\\\"correct_response\\\":{\\\"value\\\":\\\"1\\\"}}}\",\"language\":[\"English\"],\"partial_scoring\":false,\"title\":\"ಈ ಚaಿತ್ರದ ವಿಸ್xsxxxxxxxxxxxxತೀರ್ಣವನ್ನುzsaZZ ಹಾಗೂ ಸುತ್ತಳತೆಯನ್ನು ಲೆಕ್ಕ ಮಾಡಿ.  ಸೂಕ್ತ ಉತ್ತರವನ್ನು ಆರಿಸಿರಿ.\",\"type\":\"mcq\",\"createdOn\":\"2020-01-02T16:28:15.005+0530\",\"feedback\":\"\",\"options\":\"[{\\\"value\\\":{\\\"type\\\":\\\"text\\\",\\\"asset\\\":\\\"12&10\\\",\\\"resvalue\\\":0,\\\"resindex\\\":0}},{\\\"value\\\":{\\\"type\\\":\\\"text\\\",\\\"asset\\\":\\\"14&7\\\",\\\"resvalue\\\":1,\\\"resindex\\\":1}},{\\\"value\\\":{\\\"type\\\":\\\"mixed\\\",\\\"text\\\":\\\"16&8\\\",\\\"image\\\":\\\"image1\\\",\\\"audio\\\":\\\"audio1\\\",\\\"resvalue\\\":\\\"16&8\\\",\\\"resindex\\\":2}},{\\\"value\\\":{\\\"type\\\":\\\"mixed\\\",\\\"image\\\":\\\"image2\\\",\\\"audio\\\":\\\"audio2\\\",\\\"resvalue\\\":3,\\\"resindex\\\":3},\\\"answer\\\":true}]\",\"outRelations\":\"[{\\\"endNodeId\\\":\\\"Num:C1:SC1\\\",\\\"relationType\\\":\\\"associatedTo\\\"},{\\\"endNodeId\\\":\\\"Num:C1:SC1\\\",\\\"relationType\\\":\\\"associatedTo\\\"}]\",\"lastUpdatedOn\":\"2020-01-02T16:28:15.005+0530\",\"model\":\"{\\\"img\\\":{\\\"type\\\":\\\"image\\\",\\\"asset\\\":\\\"persximeter\\\"},\\\"img2\\\":{\\\"type\\\":\\\"image\\\",\\\"asset\\\":\\\"smallssssssSquare\\\"},\\\"subtext\\\":\\\"(          = 1  ಚದರ ಸೆಂ.ಮೀ)\\\"}\",\"owner\":\"username_2\",\"lastStatusChangedOn\":\"2020-01-02T16:28:15.005+0530\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"version\":1,\"tags\":[\"english\",\"hindi\"],\"versionKey\":\"1577962695005\",\"framework\":\"NCF\",\"max_score\":1,\"IL_FUNC_OBJECT_TYPE\":\"AssessmentItem\",\"name\":\"Mmcq Question 2\",\"responses\":\"[{\\\"values\\\":{\\\"12&10\\\":true},\\\"score\\\":1}]\",\"num_answers\":2,\"template_id\":\"mcq_mmtemplate_2\",\"category\":\"MCQ\",\"IL_UNIQUE_ID\":\"test.mcq_test_mcq_101\",\"status\":\"Live\"}}],\"inRelations\":[{\"id\":824398,\"graphId\":\"domain\",\"relationType\":\"hasSequenceMember\",\"startNodeId\":\"do_11292666508456755211\",\"endNodeId\":\"do_11292667205373132811\",\"startNodeName\":\"Test_PDF\",\"endNodeName\":\"Akshara Worksheet Grade 5 Item Set\",\"startNodeType\":\"DATA_NODE\",\"endNodeType\":\"DATA_NODE\",\"startNodeObjectType\":\"Content\",\"endNodeObjectType\":\"ItemSet\",\"metadata\":{\"IL_SEQUENCE_INDEX\":1},\"startNodeMetadata\":{\"ownershipType\":[\"createdBy\"],\"publish_type\":\"public\",\"previewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/content/do_11292666508456755211/artifact/1_1577963911728.pdf\",\"code\":\"Test_PDF\",\"publishError\":\"Error During Itemset Publish. Please Try Again After Sometime!\",\"downloadUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/ecar_files/do_11292666508456755211/test_pdf_1578314256565_do_11292666508456755211_21.0.ecar\",\"channel\":\"channel-1\",\"language\":[\"English\"],\"variants\":\"{\\\"spine\\\":{\\\"ecarUrl\\\":\\\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/ecar_files/do_11292666508456755211/test_pdf_1578314257331_do_11292666508456755211_21.0_spine.ecar\\\",\\\"size\\\":2088.0}}\",\"mimeType\":\"application/pdf\",\"streamingUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/content/do_11292666508456755211/artifact/1_1577963911728.pdf\",\"idealScreenSize\":\"normal\",\"createdOn\":\"2020-01-02T16:17:28.138+0530\",\"contentDisposition\":\"inline\",\"artifactUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/content/do_11292666508456755211/artifact/1_1577963911728.pdf\",\"contentEncoding\":\"identity\",\"lastUpdatedOn\":\"2020-01-07T12:34:39.496+0530\",\"SYS_INTERNAL_LAST_UPDATED_ON\":\"2020-01-06T18:07:38.351+0530\",\"contentType\":\"Resource\",\"dialcodeRequired\":\"No\",\"lastUpdatedBy\":\"Ekstep\",\"audience\":[\"Learner\"],\"lastStatusChangedOn\":\"2020-01-06T18:44:48.759+0530\",\"os\":[\"All\"],\"visibility\":\"Default\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"mediaType\":\"content\",\"osId\":\"org.ekstep.quiz.app\",\"lastPublishedBy\":\"Ekstep\",\"version\":2,\"pkgVersion\":21.0,\"pragma\":[\"external\"],\"versionKey\":\"1578380679496\",\"idealScreenDensity\":\"hdpi\",\"license\":\"Creative Commons Attribution (CC BY)\",\"framework\":\"NCF\",\"s3Key\":\"ecar_files/do_11292666508456755211/test_pdf_1578314256565_do_11292666508456755211_21.0.ecar\",\"lastPublishedOn\":\"2020-01-06T18:07:36.315+0530\",\"size\":413860.0,\"compatibilityLevel\":4,\"IL_FUNC_OBJECT_TYPE\":\"Content\",\"name\":\"Test_PDF\",\"publisher\":\"EkStep\",\"itemSetPreviewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/content/do_11292666508456755211/artifact/do_11292666508456755211_1578314178385.html\",\"IL_UNIQUE_ID\":\"do_11292666508456755211\",\"status\":\"Failed\"},\"endNodeMetadata\":{\"owner\":\"Ilimi\",\"lastStatusChangedOn\":\"2020-01-02T16:31:37.174+0530\",\"code\":\"akshara.grade5.ws1.test\",\"previewUrl\":\"https://sunbirddev.blob.core.windows.net/sunbird-content-dev/itemset/do_11292667205373132811/do_11292667205373132811_html_1578314155877.html\",\"IL_SYS_NODE_TYPE\":\"DATA_NODE\",\"channel\":\"in.ekstep\",\"SET_OBJECT_TYPE_KEY\":\"AssessmentItem\",\"description\":\"Akshara Worksheet Grade 5 Item Set\",\"language\":[\"English\"],\"title\":\"Akshara Worksheet Grade 5 Item Set\",\"type\":\"materialised\",\"total_items\":1,\"createdOn\":\"2020-01-02T16:31:37.174+0530\",\"versionKey\":\"1578314159042\",\"gradeLevel\":[\"Grade 1\"],\"max_score\":1,\"IL_FUNC_OBJECT_TYPE\":\"ItemSet\",\"lastUpdatedOn\":\"2020-01-06T18:05:59.042+0530\",\"used_for\":\"assessment\",\"items\":\"[{\\\"identifier\\\":\\\"test.mcq_test_mcq_101\\\"}]\",\"IL_UNIQUE_ID\":\"do_11292667205373132811\",\"SET_TYPE\":\"MATERIALISED_SET\",\"status\":\"Live\"}}],\"tags\":null}";
		Map<String, Object> nodeMap = mapper.readValue(itemSet, Map.class);
		DefinitionDTO d = new ControllerUtil().getDefinition("domain", "ItemSet");
		Node node = ConvertToGraphNode.convertToGraphNode(nodeMap, d, null);
		Relation r = new Relation("do_11292667205373132811", "hasSequenceMember", "test.mcq_test_mcq_101");
		Map<String, Object> relationMataData = new HashMap<>();
		relationMataData.put("IL_SEQUENCE_INDEX", 1);
		r.setMetadata(relationMataData);
		r.setStartNodeObjectType("ItemSet");
		r.setEndNodeObjectType("AssessmentItem");
		node.setOutRelations(Arrays.asList(r));
		System.out.println(node.getOutRelations().size());
		Map<String, Object> o = QuestionPaperGenerator.fetchChildDetails(node);
		Assert.assertNotNull(o);
    }
}
